#!/usr/bin/env node

const args = process.argv.slice(2);
const cmd = args[0];

async function loadErrorHandler() {
  try {
    const module = await import('../dist/errors/handler.js');
    return module.ErrorHandler;
  } catch {
    return null;
  }
}

async function main() {
  if (cmd === 'list-templates' || cmd === 'templates') {
    process.argv = ['node', 'dist/index.js', ...args];
    await import('../dist/index.js');
    return;
  }

  if (cmd === '--help' || cmd === '-h') {
    process.argv = ['node', 'dist/index.js', '--help'];
    await import('../dist/index.js');
    return;
  }

  process.argv = ['node', 'dist/index.js', ...args.slice(cmd === 'eval' ? 1 : 0)];
  await import('../dist/index.js');
}

main().catch(async (err) => {
  const ErrorHandler = await loadErrorHandler();
  
  if (ErrorHandler) {
    ErrorHandler.handle(err);
  } else {
    const isDebug = args.includes('--debug');
    console.error('\nError: An error occurred while running the CLI');
    
    if (err?.message) {
      console.error(`   ${err.message}`);
    }
    
    if (isDebug && err?.stack) {
      console.error('\n[DEBUG] Stack trace:');
      console.error(err.stack);
    } else if (!isDebug) {
      console.error('\nRun with --debug flag for more details');
    }
  }
  
  process.exit(1);
});
